<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>è¿œç¨‹çŸ¥é“äº† Â· è¿œç¨‹è¡Œä¸ºå®¡è®¡</title>
    <link rel="icon" href="assets/logo.png" type="image/x-icon">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f4f6f9;
            color: #333;
            -webkit-user-select: none;
            overflow: hidden;
            /* é˜²æ­¢å…¨å±€æ»šåŠ¨æ¡ */
        }

        header {
            background: #1f2937;
            color: #fff;
            padding: 0;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 15px;
            -webkit-app-region: drag;
        }

        .header-left {
            padding-left: 20px;
            display: flex;
            align-items: center;
        }

        .header-right {
            display: flex;
            -webkit-app-region: no-drag;
        }

        .window-btn {
            width: 46px;
            height: 48px;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .window-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .window-btn.close:hover {
            background: #e81123;
        }

        .container {
            padding: 20px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .remote {
            background: #dc2626;
        }

        .safe {
            background: #16a34a;
        }

        .status-text {
            font-size: 16px;
            font-weight: 600;
        }

        .meta {
            margin-left: auto;
            font-size: 13px;
            color: #666;
            display: none;
            /* é»˜è®¤éšè—ï¼Œä»…åœ¨æ£€æµ‹åˆ°è¿œç¨‹æ—¶æ˜¾ç¤º */
            margin-right: 16px;
            /* æ·»åŠ å³ä¾§é—´è·ï¼Œé¿å…ç´§è´´åˆ†éš”çº¿ */
        }

        .status-actions {
            /* å¦‚æœ .meta éšè—ï¼Œstatus-actions éœ€è¦è‡ªåŠ¨é å³ */
            margin-left: auto;
            padding-left: 16px;
            border-left: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }

        .action-link {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 13px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }

        .action-link:hover {
            background: #eff6ff;
        }


        .card {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .card h3 {
            margin-top: 0;
            font-size: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .refresh-btn {
            background: transparent;
            color: #666;
            border: none;
            border-radius: 4px;
            padding: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .refresh-btn:hover {
            background: #f3f4f6;
            color: #3b82f6;
        }

        .refresh-btn:active {
            background: #e5e7eb;
        }

        .refresh-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        #signals {
            min-height: 30px;
            max-height: 30px;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding: 4px 0;
        }

        .signal {
            display: inline-block;
            padding: 4px 8px;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 4px;
            font-size: 12px;
            margin: 4px 4px 0 0;
            white-space: nowrap;
        }

        .signal.bad {
            background: #fee2e2;
            color: #991b1b;
        }

        .table-container {
            overflow-x: auto;
            overflow-y: visible;
            max-height: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        th {
            background: #fafafa;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .pagination-btn {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #3b82f6;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #3b82f6;
            color: #fff;
            border-color: #3b82f6;
        }

        .pagination-info {
            font-size: 13px;
            color: #666;
            margin: 0 8px;
        }

        .settings-btn {
            width: 46px;
            height: 48px;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.15s;
            -webkit-app-region: no-drag;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-app-region: no-drag;
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 0;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #1f2937;
            color: #fff;
            padding: 16px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-group .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .form-group .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .test-result {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 8px;
        }

        .test-result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .test-result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .test-result.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* Settings Layout */
        .settings-layout {
            display: flex;
            min-height: 300px;
            padding: 0;
        }

        .settings-sidebar {
            width: 140px;
            background: #f9fafb;
            border-right: 1px solid #eee;
            padding: 16px 0;
            display: flex;
            flex-direction: column;
        }

        .tab-btn {
            padding: 10px 20px;
            text-align: left;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .tab-btn:hover {
            background: #f3f4f6;
            color: #333;
        }

        .tab-btn.active {
            background: #fff;
            color: #3b82f6;
            border-left-color: #3b82f6;
            font-weight: 500;
        }

        .settings-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .about-info {
            text-align: center;
            padding: 20px 0;
        }

        .about-info img {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
        }

        .about-info h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #1f2937;
        }

        .about-info p {
            margin: 4px 0;
            color: #666;
            font-size: 13px;
        }

        .copyright {
            margin-top: 32px;
            font-size: 12px;
            color: #9ca3af;
        }

        .repo-links {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .repo-link {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #333;
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s;
            cursor: pointer;
            background: #fff;
        }

        .repo-link:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #f8fbff;
        }

        /* Adjust modal body padding for split layout */
        .modal-body {
            padding: 0;
        }
    </style>
</head>

<body>

    <header>
        <div class="header-left">
            <span>è¿œç¨‹çŸ¥é“äº† Â· æœ¬æœºè¿œç¨‹æ§åˆ¶è¡Œä¸ºå®¡è®¡</span>
        </div>
        <div class="header-right">
            <button class="settings-btn" onclick="openSettingsModal()" title="ç³»ç»Ÿè®¾ç½®">âš™ï¸</button>
            <button class="window-btn" onclick="window.remoteAudit.minimize()">â”€</button>
            <button class="window-btn" onclick="window.remoteAudit.maximize()">â–¡</button>
            <button class="window-btn close" onclick="window.remoteAudit.close()">âœ•</button>
        </div>
    </header>

    <!-- ç³»ç»Ÿè®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h3>ç³»ç»Ÿè®¾ç½®</h3>
                <button class="modal-close" onclick="closeSettingsModal()">âœ•</button>
            </div>

            <div class="modal-body settings-layout">
                <!-- å·¦ä¾§å¯¼èˆª -->
                <div class="settings-sidebar">
                    <button class="tab-btn active" onclick="switchTab('notification')">é€šçŸ¥</button>
                    <button class="tab-btn" onclick="switchTab('feedback')">åé¦ˆ</button>
                    <button class="tab-btn" onclick="switchTab('about')">å…³äº</button>
                </div>

                <!-- å³ä¾§å†…å®¹ -->
                <div class="settings-content">

                    <!-- é€šçŸ¥è®¾ç½® Tab -->
                    <div id="tab-notification" class="tab-pane active">
                        <form id="notificationForm">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="notificationEnabled" name="enabled">
                                    <label for="notificationEnabled">å¯ç”¨é€šçŸ¥</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="notificationType">é€šçŸ¥ç±»å‹</label>
                                <select id="notificationType" name="type">
                                    <option value="feishu">é£ä¹¦</option>
                                    <option value="dingtalk">é’‰é’‰</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="webhookURL">Webhook URL</label>
                                <input type="text" id="webhookURL" name="webhook_url" placeholder="è¯·è¾“å…¥Webhookåœ°å€">
                                <div class="help-text">é£ä¹¦æˆ–é’‰é’‰æœºå™¨äººçš„Webhookåœ°å€</div>
                            </div>
                            <div class="form-group" id="secretGroup" style="display: none;">
                                <label for="webhookSecret">ç­¾åå¯†é’¥ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" id="webhookSecret" name="secret" placeholder="é’‰é’‰ç­¾åå¯†é’¥ï¼ˆå¯é€‰ï¼‰">
                                <div class="help-text">ä»…é’‰é’‰éœ€è¦ï¼Œå¦‚æœæœºå™¨äººé…ç½®äº†ç­¾åéªŒè¯ï¼Œè¯·å¡«å†™</div>
                            </div>
                            <div class="form-group">
                                <div id="testResult"
                                    style="display: none; padding: 8px; border-radius: 4px; font-size: 12px; margin-top: 8px;">
                                </div>
                            </div>
                            <div style="margin-top: 24px; text-align: right;">
                                <button type="button" class="btn btn-secondary" onclick="testNotification()"
                                    id="testBtn">æµ‹è¯•é€šçŸ¥</button>
                                <button type="button" class="btn btn-primary"
                                    onclick="saveNotificationConfig()">ä¿å­˜é…ç½®</button>
                            </div>
                        </form>
                    </div>

                    <!-- åé¦ˆ Tab -->
                    <div id="tab-feedback" class="tab-pane">
                        <div style="text-align: center; padding: 12px 0;">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; color: #1f2937;">åé¦ˆä¸äº¤æµ</h4>

                            <!-- å…¬ä¼—å·äºŒç»´ç  -->
                            <div style="margin-bottom: 16px;">
                                <img src="assets/mp_samwaf.png" alt="å¾®ä¿¡å…¬ä¼—å·"
                                    style="width: 350px; height: 100px; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);">
                                <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">æ‰«ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ï¼Œè·å–æœ€æ–°åŠ¨æ€å’ŒæŠ€æœ¯äº¤æµ</p>
                            </div>

                            <!-- é‚®ç®±è”ç³» -->
                            <div style="margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                                <p style="margin: 0 0 6px 0; font-size: 13px; color: #333; font-weight: 500;">é‚®ç®±è”ç³»</p>
                                <a href="mailto:samwafgo@gmail.com"
                                    style="color: #3b82f6; text-decoration: none; font-size: 13px;"
                                    onmouseover="this.style.textDecoration='underline'"
                                    onmouseout="this.style.textDecoration='none'">
                                    samwafgo@gmail.com
                                </a>
                            </div>

                            <!-- Issues é“¾æ¥ -->
                            <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
                                <p style="margin: 0 0 10px 0; font-size: 13px; color: #333; font-weight: 500;">æäº¤é—®é¢˜åé¦ˆ
                                </p>
                                <div
                                    style="display: flex; flex-direction: row; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                    <button class="repo-link"
                                        onclick="openExternal('https://github.com/samwafgo/RemoteKnown/issues')"
                                        style="flex: 1; min-width: 120px; padding: 6px 12px; font-size: 12px;">
                                        ğŸ“ GitHub
                                    </button>
                                    <button class="repo-link"
                                        onclick="openExternal('https://gitee.com/samwaf/remote-known/issues')"
                                        style="flex: 1; min-width: 120px; padding: 6px 12px; font-size: 12px;">
                                        ğŸ“ Gitee
                                    </button>
                                    <button class="repo-link"
                                        onclick="openExternal('https://atomgit.com/SamWaf/RemoteKnown/issues')"
                                        style="flex: 1; min-width: 120px; padding: 6px 12px; font-size: 12px;">
                                        ğŸ“ AtomGit
                                    </button>
                                </div>
                                <p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">æ¬¢è¿æäº¤ Bug æŠ¥å‘Šã€åŠŸèƒ½å»ºè®®æˆ–ä½¿ç”¨åé¦ˆ</p>
                            </div>
                        </div>
                    </div>

                    <!-- å…³äº Tab -->
                    <div id="tab-about" class="tab-pane">
                        <div class="about-info">
                            <img src="assets/logo.png" alt="Logo">
                            <h4>è¿œç¨‹çŸ¥é“äº†</h4>
                            <p>RemoteKnown</p>
                            <p style="margin-top: 16px;">
                                ç‰ˆæœ¬: <span id="appVersion">1.0.0</span>
                                <span id="updateBadge"
                                    style="display:none; background: #ef4444; color: white; padding: 2px 6px; border-radius: 99px; font-size: 10px; vertical-align: middle;">New</span>
                            </p>

                            <div id="updateSection" style="margin: 10px 0; min-height: 24px;">
                                <a href="javascript:void(0)" onclick="checkUpdate()" id="checkUpdateLink"
                                    style="color: #3b82f6; text-decoration: none; font-size: 13px;">æ£€æŸ¥æ›´æ–°</a>
                                <div id="updateInfo"
                                    style="display:none; margin-top: 8px; background: #fef2f2; padding: 10px; border-radius: 4px; border: 1px solid #fee2e2;">
                                    <p style="color: #991b1b; font-weight: bold; margin: 0 0 4px 0;">å‘ç°æ–°ç‰ˆæœ¬: <span
                                            id="newVersion"></span></p>
                                    <button class="btn btn-primary" onclick="openDownloadLink()"
                                        style="font-size: 12px; padding: 4px 12px; margin-top: 4px;">å‰å¾€ä¸‹è½½</button>
                                </div>
                            </div>

                            <p>ä¿æŠ¤æ‚¨çš„éšç§å®‰å…¨ï¼Œé˜²æ­¢æœªç»æˆæƒçš„è¿œç¨‹æ§åˆ¶ã€‚</p>

                            <div class="repo-links">
                                <button class="repo-link"
                                    onclick="openExternal('https://github.com/samwafgo/RemoteKnown')">
                                    GitHub
                                </button>
                                <button class="repo-link"
                                    onclick="openExternal('https://gitee.com/samwaf/remote-known')">
                                    Gitee
                                </button>
                                <button class="repo-link"
                                    onclick="openExternal('https://atomgit.com/SamWaf/RemoteKnown')">
                                    AtomGit
                                </button>
                            </div>

                            <div class="copyright">
                                <p>Â© 2025 RemoteKnown Team. All rights reserved.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- å½“å‰çŠ¶æ€ -->
        <div id="statusBar" class="status-bar">
            <div id="statusDot" class="dot safe"></div>
            <div id="statusText" class="status-text">å½“å‰çŠ¶æ€ï¼šæœªæ£€æµ‹åˆ°è¿œç¨‹æ§åˆ¶</div>
            <div class="meta">
                å¼€å§‹ï¼š<span id="startTime">-</span> |
                å·²æŒç»­ï¼š<span id="duration">-</span>
            </div>
            <div class="status-actions">
                <button class="action-link" onclick="openSettingsModal('feedback')">ğŸ’¬ åé¦ˆäº¤æµ</button>
                <button class="action-link" onclick="openSettingsModal('notification')">ğŸ”” é€šçŸ¥è®¾ç½®</button>
            </div>
        </div>

        <!-- åˆ¤å®šä¾æ® -->
        <div class="card" style="margin-top:20px;">
            <h3>æœ¬æ¬¡è¿œç¨‹åˆ¤å®šä¾æ®</h3>
            <div id="signals"></div>
        </div>

        <!-- å®¡è®¡å†å² -->
        <div class="card" style="margin-top:20px;">
            <h3>
                <span>è¿œç¨‹ä¼šè¯å®¡è®¡è®°å½•</span>
                <button class="refresh-btn" id="refreshHistoryBtn" onclick="loadHistory()" title="åˆ·æ–°å†å²è®°å½•">
                    <span>ğŸ”„</span>
                </button>
            </h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>å¼€å§‹æ—¶é—´</th>
                            <th>ç»“æŸæ—¶é—´</th>
                            <th>æŒç»­æ—¶é•¿</th>
                            <th>åˆ¤å®šä¾æ®</th>
                        </tr>
                    </thead>
                    <tbody id="history">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination" style="display: none;">
                <button class="pagination-btn" id="prevBtn" onclick="changePage(currentPage - 1)">ä¸Šä¸€é¡µ</button>
                <span class="pagination-info" id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                <button class="pagination-btn" id="nextBtn" onclick="changePage(currentPage + 1)">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>

    </div>

    <script>
        let lastRemoteActive = null;
        let currentPage = 1;
        const pageSize = 5;
        let totalPages = 1;

        function render(data) {
            const active = data.remote_active;

            // æ£€æµ‹çŠ¶æ€å˜åŒ–ï¼Œå¦‚æœå˜åŒ–åˆ™é‡æ–°åŠ è½½å†å²è®°å½•
            if (lastRemoteActive !== null && lastRemoteActive !== active) {
                currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                loadHistory();
            }
            lastRemoteActive = active;

            statusDot.className = 'dot ' + (active ? 'remote' : 'safe');
            statusText.innerText = active
                ? 'å½“å‰çŠ¶æ€ï¼šè¿œç¨‹æ§åˆ¶è¿›è¡Œä¸­'
                : 'å½“å‰çŠ¶æ€ï¼šæœªæ£€æµ‹åˆ°è¿œç¨‹æ§åˆ¶';

            const metaDiv = document.querySelector('.meta');
            if (active) {
                metaDiv.style.display = 'block';
                // ç§»é™¤ margin-left: autoï¼Œå› ä¸ºç°åœ¨æœ‰ä¸“é—¨çš„æ ·å¼æ§åˆ¶
                document.querySelector('.status-actions').style.marginLeft = '0';

                startTime.innerText = data.start_time ? new Date(data.start_time).toLocaleString('zh-CN') : 'æœªçŸ¥';
                duration.innerText = data.duration || 'è®¡ç®—ä¸­...';
            } else {
                metaDiv.style.display = 'none';
                document.querySelector('.status-actions').style.marginLeft = 'auto';
            }

            const signals = data.signals || [];
            const signalsDiv = document.getElementById('signals');
            signalsDiv.innerHTML = '';
            signals.forEach(s => {
                const el = document.createElement('span');
                el.className = 'signal bad';
                el.innerText = s.name || s.Name || JSON.stringify(s);
                signalsDiv.appendChild(el);
            });
        }

        // IPC æ¥å…¥
        if (window.remoteAudit) {
            window.remoteAudit.onStatusUpdate(render);
        }

        async function loadHistory(page = currentPage) {
            const refreshBtn = document.getElementById('refreshHistoryBtn');
            const iconSpan = refreshBtn ? refreshBtn.querySelector('span') : null;

            if (refreshBtn) {
                refreshBtn.disabled = true;
                if (iconSpan) {
                    iconSpan.style.display = 'inline-block';
                    iconSpan.style.transition = 'transform 0.5s linear';
                    iconSpan.style.transform = 'rotate(360deg)';
                }
            }

            if (window.remoteAudit) {
                try {
                    // è°ƒç”¨å¸¦åˆ†é¡µå‚æ•°çš„API
                    const response = await window.remoteAudit.getHistoryPaginated(page, pageSize);

                    // å…¼å®¹æ—§æ ¼å¼ï¼ˆå¦‚æœæ˜¯æ•°ç»„ï¼‰å’Œæ–°æ ¼å¼ï¼ˆå¦‚æœæ˜¯å¯¹è±¡ï¼‰
                    let history = [];
                    let total = 0;

                    if (Array.isArray(response)) {
                        // æ—§æ ¼å¼ï¼šç›´æ¥è¿”å›æ•°ç»„
                        history = response;
                        total = response.length;
                        totalPages = 1;
                    } else if (response && response.sessions) {
                        // æ–°æ ¼å¼ï¼šåˆ†é¡µå“åº”
                        history = response.sessions || [];
                        total = response.total || 0;
                        totalPages = response.totalPages || 1;
                        currentPage = response.page || page;
                    }

                    renderHistory(history);
                    updatePagination(total, currentPage, totalPages);
                } catch (error) {
                    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                    renderHistory([]);
                    updatePagination(0, 1, 1);
                }
            }

            if (refreshBtn) {
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    if (iconSpan) {
                        iconSpan.style.transform = 'rotate(0deg)';
                        iconSpan.style.transition = 'none';
                    }
                }, 500); // è‡³å°‘æ—‹è½¬0.5ç§’ä»¥å…é—ªçƒ
            }
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            loadHistory(page);
        }

        function updatePagination(total, page, totalPages) {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            pageInfo.textContent = `ç¬¬ ${page} é¡µï¼Œå…± ${totalPages} é¡µï¼ˆå…± ${total} æ¡ï¼‰`;

            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= totalPages;
        }

        function renderHistory(history) {
            const tbody = document.getElementById('history');
            tbody.innerHTML = '';

            if (!history || history.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" style="text-align: center; color: #999;">æš‚æ— å®¡è®¡è®°å½•</td>';
                tbody.appendChild(row);
                return;
            }

            history.forEach(session => {
                const row = document.createElement('tr');
                // å¤„ç† end_timeï¼šå¯èƒ½æ˜¯ nullã€undefined æˆ–ç©ºå­—ç¬¦ä¸²
                let endTime = '-';
                if (session.end_time) {
                    try {
                        endTime = new Date(session.end_time).toLocaleString('zh-CN');
                    } catch (e) {
                        endTime = '-';
                    }
                }

                // å¤„ç† durationï¼šç¡®ä¿æ˜¯æ•°å­—ï¼ˆç§’æ•°ï¼‰
                let duration = '-';
                if (session.duration !== null && session.duration !== undefined) {
                    const durationSeconds = typeof session.duration === 'number' ? session.duration : parseInt(session.duration);
                    if (!isNaN(durationSeconds) && durationSeconds >= 0) {
                        duration = formatDuration(durationSeconds);
                    }
                }

                row.innerHTML = `
            <td>${session.start_time ? new Date(session.start_time).toLocaleString('zh-CN') : '-'}</td>
            <td>${endTime}</td>
            <td>${duration}</td>
            <td>${formatSignals(session.signals)}</td>
        `;
                tbody.appendChild(row);
            });
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function formatSignals(signalsStr) {
            if (!signalsStr) return '-';
            return signalsStr.split(',').map(s => `<span class="signal bad">${s.trim()}</span>`).join('');
        }

        loadHistory();

        // ç³»ç»Ÿè®¾ç½®ç›¸å…³å‡½æ•°
        function switchTab(tabName) {
            // æ›´æ–° TabæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ›´æ–° Content æ˜¾éš
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
                pane.style.display = 'none';
            });
            const activePane = document.getElementById('tab-' + tabName);
            activePane.classList.add('active');
            activePane.style.display = 'block';
        }

        function openSettingsModal(tabName = 'notification') {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'block';

            // é‡ç½®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => { p.classList.remove('active'); p.style.display = 'none'; });

            // æ¿€æ´»æŒ‡å®šçš„ Tab
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç²¾ç¡®åŒ¹é… onclick ä¸­çš„å‚æ•°
            const targetBtn = document.querySelector(`button[onclick="switchTab('${tabName}')"]`);
            if (targetBtn) targetBtn.classList.add('active');

            const targetPane = document.getElementById('tab-' + tabName);
            if (targetPane) {
                targetPane.style.display = 'block';
                targetPane.classList.add('active');
            }

            // å¦‚æœæ˜¯é€šçŸ¥ Tabï¼ŒåŠ è½½é…ç½®
            if (tabName === 'notification') {
                const testResult = document.getElementById('testResult');
                if (testResult) {
                    testResult.style.display = 'none';
                    testResult.textContent = '';
                }
                loadNotificationConfig();
            }
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function (event) {
            const modal = document.getElementById('settingsModal');
            if (event.target == modal) {
                closeSettingsModal();
            }
        }

        // æ‰“å¼€å¤–éƒ¨é“¾æ¥
        function openExternal(url) {
            if (window.remoteAudit && window.remoteAudit.openExternal) {
                window.remoteAudit.openExternal(url);
            } else {
                window.open(url, '_blank');
            }
        }

        // ç‰ˆæœ¬æ›´æ–°ç›¸å…³
        let latestDownloadUrl = '';

        async function initVersion() {
            if (window.remoteAudit) {
                const version = await window.remoteAudit.getAppVersion();
                document.getElementById('appVersion').innerText = version;
            }
        }

        // è¯­ä¹‰åŒ–ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°
        function compareVersions(v1, v2) {
            // ç§»é™¤å‰ç¼€ v
            v1 = v1.replace(/^v/, '');
            v2 = v2.replace(/^v/, '');

            // åˆ†å‰²ç‰ˆæœ¬å·
            const parts1 = v1.split('.').map(n => parseInt(n) || 0);
            const parts2 = v2.split('.').map(n => parseInt(n) || 0);

            // è¡¥é½é•¿åº¦
            const maxLen = Math.max(parts1.length, parts2.length);
            while (parts1.length < maxLen) parts1.push(0);
            while (parts2.length < maxLen) parts2.push(0);

            // é€æ®µæ¯”è¾ƒ
            for (let i = 0; i < maxLen; i++) {
                if (parts1[i] > parts2[i]) return 1;   // v1 > v2
                if (parts1[i] < parts2[i]) return -1;  // v1 < v2
            }
            return 0; // v1 == v2
        }

        async function checkUpdate() {
            const link = document.getElementById('checkUpdateLink');
            const info = document.getElementById('updateInfo');
            const badge = document.getElementById('updateBadge');

            link.innerText = 'æ­£åœ¨æ£€æŸ¥...';
            link.style.pointerEvents = 'none';
            info.style.display = 'none';

            try {
                if (window.remoteAudit) {
                    const result = await window.remoteAudit.checkForUpdates();
                    const currentVersion = document.getElementById('appVersion').innerText;

                    if (result && result.tag_name) {
                        const latestVer = result.tag_name;
                        
                        // ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ¯”è¾ƒ
                        const comparison = compareVersions(latestVer, currentVersion);
                        
                        if (comparison > 0) {
                            // æœ‰æ–°ç‰ˆæœ¬
                            document.getElementById('newVersion').innerText = result.tag_name;
                            info.style.display = 'block';
                            badge.style.display = 'inline-block';
                            latestDownloadUrl = result.html_url;
                            link.innerText = 'å‘ç°æ–°ç‰ˆæœ¬';
                        } else {
                            link.innerText = 'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬';
                            setTimeout(() => { link.innerText = 'æ£€æŸ¥æ›´æ–°'; }, 2000);
                        }
                    } else {
                        link.innerText = 'æš‚æ— æ›´æ–°';
                        setTimeout(() => { link.innerText = 'æ£€æŸ¥æ›´æ–°'; }, 2000);
                    }
                }
            } catch (e) {
                console.error(e);
                link.innerText = 'æ£€æŸ¥å¤±è´¥';
                setTimeout(() => { link.innerText = 'æ£€æŸ¥æ›´æ–°'; }, 2000);
            } finally {
                link.style.pointerEvents = 'auto';
            }
        }

        function openDownloadLink() {
            if (latestDownloadUrl) {
                openExternal(latestDownloadUrl);
            }
        }

        // åˆå§‹åŒ–
        initVersion();

        // ç¼“å­˜ä¸åŒç±»å‹çš„é€šçŸ¥é…ç½®
        let notificationConfigs = {
            feishu: { webhook_url: '', secret: '' },
            dingtalk: { webhook_url: '', secret: '' }
        };
        let currentNotificationType = 'feishu';

        // é€šçŸ¥ç±»å‹æ”¹å˜æ—¶æ˜¾ç¤º/éšè—ç­¾åå¯†é’¥å­—æ®µï¼Œå¹¶åˆ‡æ¢é…ç½®
        document.getElementById('notificationType').addEventListener('change', function () {
            // ä¿å­˜åˆ‡æ¢å‰çš„ç±»å‹çš„é…ç½®åˆ°ç¼“å­˜ï¼ˆä½¿ç”¨æ—§çš„ currentNotificationTypeï¼‰
            notificationConfigs[currentNotificationType] = {
                webhook_url: document.getElementById('webhookURL').value.trim(),
                secret: document.getElementById('webhookSecret').value.trim()
            };
            
            // åˆ‡æ¢åˆ°æ–°ç±»å‹
            currentNotificationType = this.value;
            
            // åŠ è½½æ–°ç±»å‹çš„é…ç½®
            loadTypeFromCache(currentNotificationType);
            
            // æ˜¾ç¤º/éšè—ç­¾åå¯†é’¥å­—æ®µ
            const secretGroup = document.getElementById('secretGroup');
            if (this.value === 'dingtalk') {
                secretGroup.style.display = 'block';
            } else {
                secretGroup.style.display = 'none';
            }
        });

        // ä¿å­˜å½“å‰è¡¨å•æ•°æ®åˆ°ç¼“å­˜
        function saveCurrentTypeToCache() {
            const type = document.getElementById('notificationType').value;
            notificationConfigs[type] = {
                webhook_url: document.getElementById('webhookURL').value.trim(),
                secret: document.getElementById('webhookSecret').value.trim()
            };
        }

        // ä»ç¼“å­˜åŠ è½½æŒ‡å®šç±»å‹çš„é…ç½®åˆ°è¡¨å•
        function loadTypeFromCache(type) {
            const config = notificationConfigs[type];
            document.getElementById('webhookURL').value = config.webhook_url || '';
            document.getElementById('webhookSecret').value = config.secret || '';
        }

        async function loadNotificationConfig() {
            if (!window.remoteAudit) return;

            try {
                const config = await window.remoteAudit.getNotificationConfig();
                if (config) {
                    // åŠ è½½åŸºæœ¬é…ç½®
                    document.getElementById('notificationEnabled').checked = config.enabled || false;
                    currentNotificationType = config.type || 'feishu';
                    document.getElementById('notificationType').value = currentNotificationType;
                    
                    // åŠ è½½æ‰€æœ‰ç±»å‹çš„é…ç½®åˆ°ç¼“å­˜
                    if (config.feishu) {
                        notificationConfigs.feishu = {
                            webhook_url: config.feishu.webhook_url || '',
                            secret: config.feishu.secret || ''
                        };
                    }
                    if (config.dingtalk) {
                        notificationConfigs.dingtalk = {
                            webhook_url: config.dingtalk.webhook_url || '',
                            secret: config.dingtalk.secret || ''
                        };
                    }
                    
                    // æ˜¾ç¤ºå½“å‰ç±»å‹çš„é…ç½®
                    loadTypeFromCache(currentNotificationType);

                    // æ ¹æ®ç±»å‹æ˜¾ç¤º/éšè—ç­¾åå¯†é’¥å­—æ®µ
                    const secretGroup = document.getElementById('secretGroup');
                    if (currentNotificationType === 'dingtalk') {
                        secretGroup.style.display = 'block';
                    } else {
                        secretGroup.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½é€šçŸ¥é…ç½®å¤±è´¥:', error);
            }
        }

        async function testNotification() {
            if (!window.remoteAudit) return;

            const testBtn = document.getElementById('testBtn');
            const testResult = document.getElementById('testResult');

            // è·å–å½“å‰è¡¨å•é…ç½®
            const config = {
                type: document.getElementById('notificationType').value,
                webhook_url: document.getElementById('webhookURL').value.trim(),
                secret: document.getElementById('webhookSecret').value.trim()
            };

            // éªŒè¯
            if (!config.webhook_url) {
                testResult.style.display = 'block';
                testResult.className = 'test-result error';
                testResult.textContent = 'è¯·å…ˆå¡«å†™Webhook URL';
                return;
            }

            // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            testResult.style.display = 'block';
            testResult.className = 'test-result info';
            testResult.textContent = 'æ­£åœ¨å‘é€æµ‹è¯•é€šçŸ¥...';

            try {
                const result = await window.remoteAudit.testNotification(config);
                if (result && result.success) {
                    testResult.className = 'test-result success';
                    testResult.textContent = 'âœ“ æµ‹è¯•é€šçŸ¥å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥æ‚¨çš„é£ä¹¦/é’‰é’‰æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯ã€‚';
                } else {
                    testResult.className = 'test-result error';
                    testResult.textContent = 'âœ— æµ‹è¯•å¤±è´¥: ' + (result?.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                testResult.className = 'test-result error';
                testResult.textContent = 'âœ— æµ‹è¯•å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'æµ‹è¯•é€šçŸ¥';
            }
        }

        async function saveNotificationConfig() {
            if (!window.remoteAudit) return;

            const config = {
                enabled: document.getElementById('notificationEnabled').checked,
                type: document.getElementById('notificationType').value,
                webhook_url: document.getElementById('webhookURL').value.trim(),
                secret: document.getElementById('webhookSecret').value.trim()
            };

            // éªŒè¯
            if (config.enabled && !config.webhook_url) {
                alert('è¯·å¡«å†™Webhook URL');
                return;
            }

            try {
                const result = await window.remoteAudit.saveNotificationConfig(config);
                // æ£€æŸ¥è¿”å›ç»“æœ
                if (result && (result.status === 'success' || result.success)) {
                    alert('ä¿å­˜æˆåŠŸ');
                    closeSettingsModal();
                } else {
                    // å¦‚æœè¿”å›äº†ç»“æœä½†æ²¡æœ‰æˆåŠŸæ ‡è¯†ï¼Œä¹Ÿè®¤ä¸ºä¿å­˜æˆåŠŸï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
                    if (result !== null && result !== undefined) {
                        alert('ä¿å­˜æˆåŠŸ');
                        closeSettingsModal();
                    } else {
                        throw new Error('ä¿å­˜å¤±è´¥ï¼šæœåŠ¡å™¨æœªè¿”å›æœ‰æ•ˆå“åº”');
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜é€šçŸ¥é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }
    </script>

</body>

</html>